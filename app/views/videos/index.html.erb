<h1 class="text-center">All Videos</h1>

<!-- 感想の一覧表示 -->
<h2 class="text-center"><%= link_to '感想一覧', reviews_path %></h2>

<div class="text-center">
  <%= render 'search_form' %>
</div>

<div id="time-filters" class="text-center">
  <div class="results-filter">
    <span>アップロード日:</span>
    <%= link_to '1日以内', search_videos_path(time_filter: 'today', search_query: session[:last_search_query]), class: 'time-filter' %>
    <%= link_to '1週間以内', search_videos_path(time_filter: 'thisweek', search_query: session[:last_search_query]), class: 'time-filter' %>
    <%= link_to '1ヶ月以内', search_videos_path(time_filter: 'thismonth', search_query: session[:last_search_query]), class: 'time-filter' %>
    <%= link_to '1年以内', search_videos_path(time_filter: 'thisyear', search_query: session[:last_search_query]), class: 'time-filter' %>
    <!-- 他のフィルターリンクもここに追加 -->
  </div>
</div>

<%= link_to '新しい順', search_videos_path(sort: 'newest', search_query: session[:last_search_query]) %>

<% if flash[:error] %>
  <div class="alert alert-danger">
    <%= flash[:error] %>
  </div>
<% end %>

<% if flash[:alert] %>
  <div class="alert alert-danger">
    <%= flash[:alert] %>
  </div>
<% end %>

<% if @videos.any? %>
  <div class="video-list">
    <% @videos.each do |video| %>
      <div class="video-item">
        <div class="video-thumbnail">
          <%= link_to image_tag("https://img.youtube.com/vi/#{video.video_id}/0.jpg", alt: video.title, class: "thumbnail-image"), video_path(id: video.id) %>
        </div>
        <div class="video-info">
          <h3 class="video-title"><%= link_to video.title, video_path(video) %></h3>
          <p class="video-published">公開日: <%= video.published_at ? video.published_at.to_time.strftime("%B %d, %Y") : "Not available" %></p>
          <p class="video-views">再生数: <%= number_with_delimiter(video.view_count) %></p>
          <p class="video-duration">再生時間: <%= video.duration %></p>
          <p class="video-channel">チャンネル名: <%= video.channel_title %></p>
          <p class="video-description">説明: <%= truncate(video.description, length: 100) %></p>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <p>No videos found</p>
<% end %>

<!-- 以下は無限スクロールのためのJavaScriptコード -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.time-filter').forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        document.querySelectorAll('.time-filter').forEach(function(el) {
          el.style.color = 'blue';
        });
        event.target.style.color = 'green';
        searchVideos(event.target.dataset.filter);
      });
    });

    document.querySelectorAll('.results-filter').forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        var count = event.target.dataset.count;
        var query = document.querySelector('input[name="search_query"]').value;
        window.location.href = `/videos/search?search_query=${query}&max_results=${count}`;
      });
    });
  });

  var page = 2;
  <% if @videos.respond_to?(:total_pages) %>
    var total_pages = <%= @videos.total_pages %>;
  <% else %>
    var total_pages = 1; // ページネーションが適用されていない場合はデフォルト値を設定
  <% end %>
  var total_videos_loaded = 30; // 初期ロードで20件の動画が表示されている

  window.onscroll = function() {
    if (total_videos_loaded >= 30) {
      // 既に30件の動画が表示されている場合、追加の読み込みを行わない
      return;
    }

    if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
      if (page <= total_pages) {
        fetchMoreVideos(page);
        page++;
      }
    }
  };

  function fetchMoreVideos(page) {
    var query = document.querySelector('input[name="search_query"]').value;
    var url = `/videos/search?search_query=${encodeURIComponent(query)}&page=${page}`;
    fetch(url)
      .then(response => response.text())
      .then(html => {
        var div = document.createElement('div');
        div.innerHTML = html;
        var newVideos = div.querySelector('.video-list');
        if (newVideos) {
          document.querySelector('.video-list').appendChild(newVideos);
          total_videos_loaded += newVideos.childElementCount;
        }
      })
      .catch(error => console.error('Error:', error));
  }
</script>
