<%# ページのタイトル %>
<h1 class="text-center">感想一覧</h1>

<%# ナビゲーションリンク %>
<div class="text-center">
  <%= link_to '動画検索ページへ戻る', videos_path %>
</div>

<div class="text-center">
  <%# キーワード検索フォーム %>
  <div class="form-item">
    <%= form_with url: reviews_path, method: :get, local: true do |form| %>
      <%= form.label :search, '検索キーワード' %>
      <%= form.text_field :search, value: params[:search] %>
      <%= form.submit '検索' %>
    <% end %>
  </div>

  <%# タイトル検索フォーム %>
  <div class="form-item">
    <%= form_with url: reviews_path, method: :get, local: true, remote: true do %>
      <%= label_tag :title_search, 'タイトル' %>
      <%= text_field_tag :title_search, params[:title_search] %>
      <%= submit_tag '検索' %>
    <% end %>
  </div>

  <%# 並べ替えフォーム %>
  <div class="form-item">
    <%= form_with url: reviews_path, method: :get, local: true, remote: true do %>
      <%= label_tag :sort, '並べ替え' %>
      <%= select_tag :sort, options_for_select([['降順', 'created_at DESC'], ['昇順', 'created_at ASC']], params[:sort]) %>
      <%= submit_tag '適用' %>
    <% end %>
  </div>

  <%# フォルダフィルタリングフォームと削除リンクを含むdiv %>
  <div class="folder-filter-container" style="display: flex; align-items: center; justify-content: center; gap: 20px;">
    <div class="form-item">
      <%= form_with url: reviews_path, method: :get, local: true do |f| %>
        <%= f.label :folder_id, 'フォルダでフィルター' %>
        <%= f.collection_select :folder_id, current_user.folders, :id, :name, { include_blank: 'すべてのフォルダ' }, { id: 'folder_filter_select' } %>
        <%= f.submit 'フィルター' %>
      <% end %>
    </div>

    <!-- 動的に更新される削除リンク -->
    <%= link_to '削除', '#', id: 'folder-delete-link', method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'delete-folder-link', style: 'display: none;' %>
  </div>
</div>

<%# 感想の一覧表示 - カードレイアウト %>
<div id="reviews" class="review-cards">
  <% @reviews.each do |review| %>
    <div class="review-card">
      <% if review.video.video_id.present? %>
        <div class="review-thumbnail">
          <%= link_to image_tag("https://img.youtube.com/vi/#{review.video.video_id}/0.jpg", alt: review.video.title), video_path(review.video) %>
        </div>
      <% end %>

      <div class="review-card-header">
        <h3><%= link_to review.video.title, video_path(review.video) %></h3>
      </div>

      <div class="review-content">
        <p><%= truncate(review.body, length: 14) %></p>
        <small>投稿日: <%= review.created_at.strftime("%Y-%m-%d %H:%M:%S") %></small>
      </div>

      <div class="review-actions">
        <%= link_to '編集', edit_review_path(review), class: 'action-link' %>
        <%= link_to '削除', review_path(review), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'action-link' %>
      </div>
    </div>
  <% end %>
</div>

<%# ページネーションリンク %>
<% if @reviews.total_pages > 1 %>
  <div class="pagination-links text-center" style="margin-top: 20px;">
    <% if @prev_page_token %>
      <%= link_to '前へ', reviews_path(page: @prev_page_token), class: 'btn btn-secondary' %>
    <% end %>
    <% if @next_page_token %>
      <%= link_to '次へ', reviews_path(page: @next_page_token), class: 'btn btn-secondary' %>
    <% end %>
  </div>
<% end %>

<script>
  function setupFolderFilterSelect() {
    const folderFilterSelect = document.getElementById('folder_filter_select');
    const deleteLink = document.getElementById('folder-delete-link');

    if (!folderFilterSelect) return; // フォルダフィルターのセレクトが存在しない場合は何もしない

    folderFilterSelect.addEventListener('change', function() {
      const selectedFolderId = this.value;
      if (selectedFolderId) {
        deleteLink.href = `/folders/${selectedFolderId}`;
        deleteLink.style.display = 'inline';
      } else {
        deleteLink.style.display = 'none';
      }
    });
  }

  document.addEventListener('turbo:load', setupFolderFilterSelect);
</script>

<style>
:root {
  --font-size-base: 16px;
  --card-gap: 10px;
}

body {
  font-size: var(--font-size-base);
  line-height: 1.6;
}

.review-cards {
  display: flex;
  flex-wrap: wrap;
  gap: var(--card-gap);
  padding: 10px;
}

.review-card {
  width: calc(20% - var(--card-gap));
  box-sizing: border-box;
  margin: 10px 0;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow: hidden;
  background-color: #fff;
  transition: transform 0.3s ease;
}

.review-thumbnail {
  width: 100%;
  text-align: center;
  margin-bottom: 10px;
}

.review-thumbnail img {
  width: 100%;
  height: auto;
  display: block;
  margin: 0;
}

.review-card-header h3 {
  font-size: 1.2rem;
  margin: 0 0 10px 0;
  text-align: center;
}

.review-content {
  margin: 10px 0;
  text-align: center;
}

.review-content p {
  margin: 0 0 10px 0;
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.review-content small {
  display: block;
}

.review-actions {
  text-align: center;
  margin-top: 10px;
}

.action-link {
  margin: 0 5px;
  text-decoration: none;
  color: #007bff;
}

.action-link:hover {
  text-decoration: underline;
}

/* メディアクエリでレスポンシブ対応 */
@media (max-width: 1200px) {
  .review-card {
    width: calc(25% - var(--card-gap));
  }
}

@media (max-width: 992px) {
  .review-card {
    width: calc(33.3333% - var(--card-gap));
  }
}

@media (max-width: 768px) {
  .review-card {
    width: calc(50% - var(--card-gap));
  }
}

@media (max-width: 576px) {
  .review-card {
    width: 100%;
  }
}
</style> 
